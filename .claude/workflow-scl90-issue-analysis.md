# SCL-90 开发问题分析与 Workflow 改进建议

> 日期: 2025-12-16
> 问题: 雷达图显示所有维度为 0
> 根本原因: Workflow 缺少针对特殊量表类型的雷达图数据处理指导

---

## 🔍 问题回顾

### 发生了什么
开发 SCL-90 量表时，虽然按照 workflow 完成了所有步骤：
1. ✅ 创建量表数据文件 (lib/scales/scl90.ts)
2. ✅ 实现自定义计算逻辑 (lib/scales/scl90-calculator.ts)
3. ✅ 注册量表 (lib/scales/index.ts)
4. ✅ 集成 quiz 页面
5. ✅ 创建 ShareCard 组件
6. ✅ 集成 result 页面

但在测试时发现：**雷达图所有维度都显示为 0**

### 实际问题
- 用户的测评结果：总分 132, GSI 1.47, PST 11, PSDI 12.00
- 因子分应该在 1-5 范围内（例如 1.5, 1.2, 1.3 等）
- 但雷达图显示所有维度都是 0

### 根本原因
**result 页面的雷达图数据生成逻辑缺少对 SCL-90 特殊评分制的处理**

SCL-90 使用 **1-5 分制**的因子分（不是 0-100 百分比），但系统默认将其按照 0-100 量表进行归一化：

```typescript
// 错误的处理（使用了通用归一化）
normalizedValue = normalizeDimensionScore(
  dimScore,           // 1.47
  dimension.questionIds.length,
  scoreRange.min,     // 90
  scoreRange.max      // 450
);
// 结果: 接近 0
```

正确的处理应该是：
```typescript
// SCL-90 的因子分是 1-5 分制，直接使用原始分数
radarData = scale.dimensions?.map((dimension) => ({
  dimension: dimension.name,
  value: result.dimensionScores![dimension.id] || 0,
  fullMark: 5,  // 关键：不是 100！
}));
```

---

## 📊 为什么 Workflow 没有捕获这个问题？

### 当前 Workflow 的覆盖情况

#### ✅ 已覆盖的内容
1. **量表数据结构** - 完整的步骤说明
2. **自定义计算逻辑** - 有模式和示例
3. **quiz 页面集成** - 详细的代码模板
4. **基础测试** - 计分测试、数据提交测试

#### ❌ 遗漏的关键点

**步骤 5: 实现结果展示页** 部分存在的问题：

1. **没有明确雷达图数据处理的特殊情况**
   - 当前只说"维度雷达图 (如有)"
   - 没有说明不同评分制的量表需要特殊处理

2. **缺少雷达图数据格式的说明**
   - 没有说明 `fullMark` 应该根据量表的评分制设置
   - 没有说明何时需要归一化、何时直接使用原始分数

3. **测试清单不够细致**
   - "维度雷达图正确 (如适用)" 太笼统
   - 没有具体的验证标准（例如：数值范围是否合理）

4. **缺少特殊量表类型的分类指导**
   - 现有分类：简单求和、自定义计算、混合模式
   - 但没有按 **评分制** 分类：
     - 0-100 百分比制（EQ, PAT）
     - 1-5 分制（SCL-90, ESS）
     - 1-7 分制（可能的其他量表）
     - 0-1 归一化（ZHZ, Zootopia）

---

## 🛠️ 应该如何改进 Workflow

### 改进 1: 在步骤 5 添加"雷达图数据处理"专节

**新增内容**（插入到步骤 5 的"任务"部分）：

```markdown
### 步骤 5: 实现结果展示页 (如需要特殊展示)

#### 5.1 雷达图数据处理（重要！）

**核心原则**: 雷达图的 `fullMark` 必须与量表的评分制匹配

**常见评分制及处理方式**:

| 量表评分制 | fullMark 设置 | 数据处理 | 示例量表 |
|-----------|--------------|---------|----------|
| 1-5 分制 | 5 | 直接使用因子分 | SCL-90, ESS |
| 1-7 分制 | 7 | 直接使用因子分 | 某些自评量表 |
| 0-100 百分比 | 100 | 使用归一化分数 | EQ, PAT, Workhorse |
| 0-1 归一化 | 100 | 乘以 100 转为百分比 | ZHZ, Zootopia |

**实现位置**: `app/scales/[scaleId]/result/[resultId]/page.tsx`

**代码模板**:

\`\`\`typescript
// 在 ShareCard 渲染逻辑中添加
} else if (scaleId === '{your-scale-id}' && result.dimensionScores) {
  // 根据量表的评分制选择处理方式

  // 方式 1: 1-5 分制（如 SCL-90）
  radarData = scale.dimensions?.map((dimension) => ({
    dimension: dimension.name,
    value: Math.round((result.dimensionScores![dimension.id] || 0) * 100) / 100,
    fullMark: 5,  // ← 关键
  }));

  // 方式 2: 0-100 百分比制（如 EQ, PAT）
  radarData = scale.dimensions?.map((dimension) => ({
    dimension: dimension.name,
    value: result.dimensionScores![dimension.id] || 0,
    fullMark: 100,
  }));

  // 方式 3: 0-1 归一化（如 ZHZ）
  radarData = scale.dimensions?.map((dimension) => ({
    dimension: dimension.name,
    value: (result.dimensionScores![dimension.id] || 0) * 100,
    fullMark: 100,
  }));
}
\`\`\`

**检查清单**:
- [ ] 确认量表的评分制（1-5, 1-7, 0-100, 0-1）
- [ ] fullMark 设置正确
- [ ] 雷达图数值范围合理（不应该全是 0 或全是 100）
- [ ] 与分享卡片的雷达图保持一致
```

### 改进 2: 增强步骤 6 的测试清单

**修改前**:
```markdown
**结果展示测试**:
- [ ] 维度雷达图正确 (如适用)
```

**修改后**:
```markdown
**结果展示测试**:
- [ ] 总分和等级显示正确
- [ ] 分数段描述显示正确
- [ ] **维度雷达图显示正确 (如适用)**:
  - [ ] 所有维度数值在合理范围内（不全是 0 或 100）
  - [ ] fullMark 与量表评分制匹配
  - [ ] 雷达图形状能反映真实的维度差异
  - [ ] ShareCard 和结果页的雷达图一致
- [ ] 建议列表完整
- [ ] 百分位数显示正确 (如有样本)
- [ ] 分享功能正常
```

### 改进 3: 在"测评类型快速参考"中添加评分制信息

**修改表格**:

```markdown
| 量表 | 类型 | 计分方式 | **评分制** | 特殊功能 | 参考实现 |
|------|------|---------|-----------|---------|---------|
| ESS | 简单 | 求和 | **1-5 分制** | 反向题 | 模式1 |
| INI | 简单 | 求和 | **1-5 分制** | 多分数段 | 模式1 |
| SCL-90 | 复杂 | 自定义 | **1-5 分制因子分** | 危机预警 | 模式2 + 独立文件 |
| ANI | 复杂 | 自定义 | **百分比** | 多维度复杂计分 | 模式2 + 独立文件 |
| PAT | 复杂 | 自定义 | **0-100** | 心理年龄计算 | 模式2 + metadata |
| ZHZ | 复杂 | 自定义 | **0-1 归一化** | 角色匹配 | 模式2 + 自定义结果页 |
| EQ | 混合 | 自定义 | **0-100** | 正反向题 | 模式3 |
```

### 改进 4: 添加新的"常见陷阱"

在"⚠️ 常见陷阱和注意事项"章节添加：

```markdown
### 8. 雷达图数据格式错误
❌ **错误**: 使用错误的 fullMark 值
\`\`\`typescript
// SCL-90 是 1-5 分制，但错误地使用了 100
radarData = scale.dimensions?.map((dimension) => ({
  dimension: dimension.name,
  value: result.dimensionScores![dimension.id] || 0,  // 1.47
  fullMark: 100,  // ❌ 错误！应该是 5
}));
// 结果: 雷达图显示 1.47/100 ≈ 0
\`\`\`

✅ **正确**: fullMark 与评分制匹配
\`\`\`typescript
// 1-5 分制量表
radarData = scale.dimensions?.map((dimension) => ({
  dimension: dimension.name,
  value: result.dimensionScores![dimension.id] || 0,  // 1.47
  fullMark: 5,  // ✅ 正确
}));
// 结果: 雷达图显示 1.47/5 ≈ 30% 的填充
\`\`\`

**如何避免**:
1. 在开发前明确量表的评分制
2. 参考同类评分制的现有量表（如 ESS 也是 1-5 分制）
3. 测试时检查雷达图数值范围是否合理
\`\`\`

---

## 📝 具体修复方案（针对 SCL-90）

### 已完成的修复
在 `app/scales/[scaleId]/result/[resultId]/page.tsx` 的第 276-282 行添加：

```typescript
} else if (isSCL90 && result.dimensionScores) {
  // 对于 SCL-90 量表，因子分是 1-5 分制，直接使用原始分数
  radarData = scale.dimensions?.map((dimension) => ({
    dimension: dimension.name,
    value: Math.round((result.dimensionScores![dimension.id] || 0) * 100) / 100,
    fullMark: 5,
  }));
}
```

### 验证结果
- ✅ TypeScript 编译无错误
- ✅ 开发服务器正常启动
- ✅ 雷达图数据测试通过
- ✅ 数值范围正确（1-5 范围）

---

## 🎯 关键教训

### 1. 评分制是量表的核心属性
不同的评分制需要不同的数据处理方式，这应该在开发初期就明确。

### 2. 雷达图是评分制的视觉表现
雷达图的 fullMark 必须与量表的评分制完全匹配，否则会导致视觉误导。

### 3. 测试要覆盖边界和合理性
不仅要测试"有没有雷达图"，还要测试"雷达图是否合理"。

### 4. 分类应该多维度
量表的分类不仅要按计分方式（简单/复杂），还要按评分制（1-5/0-100 等）。

### 5. 参考示例要全面
每种评分制都应该有明确的参考示例，避免开发者误用。

---

## ✅ Workflow 更新建议总结

| 章节 | 问题 | 建议修改 | 优先级 |
|-----|------|---------|-------|
| 步骤 5 | 缺少雷达图处理指导 | 新增"5.1 雷达图数据处理"专节 | 🔴 高 |
| 步骤 6 测试 | 雷达图测试不够细致 | 增强雷达图测试清单 | 🔴 高 |
| 测评类型参考 | 缺少评分制信息 | 添加"评分制"列 | 🟡 中 |
| 常见陷阱 | 未涵盖雷达图问题 | 添加"陷阱 8: 雷达图数据格式错误" | 🟡 中 |
| 开发前准备 | 未要求明确评分制 | 在步骤 2 添加"确认评分制" | 🟢 低 |

---

## 📚 未来预防措施

### 对于开发者
1. 在开发新量表前，先回答：**这个量表的评分制是什么？**
2. 在实现雷达图前，先查看：**同类评分制的量表如何处理？**
3. 在测试时，检查：**雷达图的数值范围是否合理？**

### 对于 Workflow
1. 明确要求在开发前确认评分制
2. 提供每种评分制的标准处理模板
3. 增强测试清单，覆盖合理性检查

### 对于代码
1. 考虑在量表定义中增加 `scoreScale` 字段（可选）：
   ```typescript
   scoreScale: '1-5' | '1-7' | '0-100' | '0-1'
   ```
2. 雷达图数据生成可以根据这个字段自动选择处理方式

---

**结论**:
这次问题不是 workflow 完全缺失相关内容，而是 **不够具体、不够详细**。特别是对于雷达图这种跨量表的通用组件，需要更明确的分类指导和处理模板。

通过这次问题，我们学到：
- ✅ Workflow 需要覆盖"特殊情况的特殊处理"
- ✅ 测试清单要包含"合理性验证"，不仅是"功能是否存在"
- ✅ 参考示例要按照多个维度分类（不仅是简单/复杂）

**下一步**: 更新 `assessment-development-workflow.md`，融入上述改进建议。
